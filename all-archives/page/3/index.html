
<!DOCTYPE html>
<html lang="en">
    
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jason&#39;s blog">
    <title>Archives - Jason&#39;s blog</title>
    <meta name="author" content="Jason Ma">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Valar morghulis, valar dohaeris.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Jason&#39;s blog">
<meta property="og:url" content="http://www.mazhixian.me/all-archives/page/3/index.html">
<meta property="og:site_name" content="Jason&#39;s blog">
<meta property="og:description" content="Valar morghulis, valar dohaeris.">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jason&#39;s blog">
<meta name="twitter:description" content="Valar morghulis, valar dohaeris.">
    
    
        
    
    
        <meta property="og:image" content="http://www.mazhixian.me/assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-pz4cc6y13wt2trzqa8l3n9v0yykr0sstdaheem7qj628nhjmhp9pfawvqawz.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-112822605-1', 'auto');
        ga('send', 'pageview');
    </script>


    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?20f3bcc8683b066ff79f4e36134e3982";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

    <body>
        <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Jason&#39;s blog</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Jason Ma</h4>
                
                    <h5 class="sidebar-profile-bio"><p>We are in the same story.</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/myinxd" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:zx@mazhixian.me" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/404.html"
                            
                            title="Naive"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-hourglass-start" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Naive</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/23/multiple-websites-with-nginx/">
                            multiple websites with nginx
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-23T22:31:05+08:00">
	
		    Jan 23, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>前面写过<a href="http://www.mazhixian.me/2018/01/22/hexo-deploy-google-analytics-to-your-website/">文章</a>讨论如何在Hexo搭建的网站里添加Google Analytics, 想着把百度的分析也用起来，顺便去百度站长看了一下网站的检索情况，然后就发现github把百度的爬虫给墙了，返回的都是403。解决方法有以下几种，</p>
<ol>
<li>利用gitcafe作为github的镜像，再利用dnspod将国内访问解析到gitcafe上，国外域名解析到github上</li>
<li>自己利用vps搭服务器，同样用dnspod进行解析。</li>
</ol>
<p>我准备尝试后者。</p>
<p>考虑到已经在vps上挂了一个网站，此刻如果镜像github的网站，就得让nginx部署两个网站，即虚拟服务器，参考了几篇博客，记录一下配置的过程。</p>
<h4 id="1-定位nginx的配置文件"><a href="#1-定位nginx的配置文件" class="headerlink" title="1. 定位nginx的配置文件"></a>1. 定位nginx的配置文件</h4><p>如果是用<a href="https://lnmp.org" target="_blank" rel="external">lnmp</a>安装的nginx,其配置文件在<code>/usr/local/nginx/conf/nginx.conf</code>中，可以通过cat查看，应该是默认配置了一个default服务器。</p>
<h4 id="2-修改-vhost-conf，添加多个网站配置"><a href="#2-修改-vhost-conf，添加多个网站配置" class="headerlink" title="2. 修改./vhost/*.conf，添加多个网站配置"></a>2. 修改./vhost/*.conf，添加多个网站配置</h4><p>参考[2]，按照如下过程配置，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx/cong/vhost</div><div class="line">$ sudo vim vhost_myweb.conf</div></pre></td></tr></table></figure></p>
<p>添加如下行，以网站路径为/home/wwwroot/myweb为例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">server</div><div class="line">    &#123;</div><div class="line">	listen 80;</div><div class="line">	server_name xxx.xxx.xxx;</div><div class="line">	index index.html;</div><div class="line">	root /home/wwwroot/myweb;</div><div class="line">	<span class="comment">#php</span></div><div class="line">	location ~ /.php$ &#123;</div><div class="line">		include fastcgi_params;</div><div class="line">		fastcgi_pass 127.0.0.1:9000;</div><div class="line">		fastcgi_index index.php;</div><div class="line">		fastcgi_param SCRIPT_FILENAME /home/wwwroot/myweb<span class="variable">$fastcgi_script_name</span>;</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着，修改<code>/usr/local/php/etc/php-fpm.conf</code>为<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[www]</div><div class="line"><span class="comment"># listen = /tmp/php-cgi.sock</span></div><div class="line">listen = 127.0.0.1:9000</div></pre></td></tr></table></figure></p>
<p>最后重启php和nginx服务，如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo killall php-fpm</div><div class="line">$ sudo systemctl start php-fpm.service</div><div class="line">$ sudo /etc/init.d/nginx restart</div></pre></td></tr></table></figure></p>
<p>到此便配置完毕。</p>
<h4 id="502-bad-gateway-问题"><a href="#502-bad-gateway-问题" class="headerlink" title="502 bad gateway 问题"></a>502 bad gateway 问题</h4><p>在配置过程中碰到了<strong>502 bad gateway</strong>的问题，引起502的可能因素很多，其中对于lnmp常见的就是nginx和php通信的问题。常用的通信方法有两种，分别是socket和ip:port。这里我采用的是ip:port。详细的解释可以参考<a href="http://www.linuxidc.com/Linux/2015-11/125068.htm" target="_blank" rel="external">这篇文章</a></p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] <a href="https://www.zhihu.com/question/30898326" target="_blank" rel="external">如何解决百度爬虫无法爬取搭建在Github上的个人博客的问题？</a><br>[2] <a href="https://www.cnblogs.com/Erick-L/p/7066564.html" target="_blank" rel="external">在Nginx上配置多个站点</a><br>[3] <a href="http://blog.csdn.net/wzqzhq/article/details/53320533" target="_blank" rel="external">nginx502错误和错误日志级别</a><br>[4] <a href="http://www.linuxidc.com/Linux/2015-11/125068.htm" target="_blank" rel="external">LNMP 常见502 Bad Gateway问题汇总</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/23/multiple-websites-with-nginx/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/23/batch-normalization-with-tensorflow/">
                            Batch normalization with TensorFlow
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-23T11:28:01+08:00">
	
		    Jan 23, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>ResNet的坑还没填，先挖Batch Normalization (BN)的坑吧。读了Ioffe &amp; Szegedy 2015年的<a href="http://proceedings.mlr.press/v37/ioffe15.html" target="_blank" rel="external">论文</a>,做个笔记。参考了几篇相关的博客，还是很有帮助的。如<a href="http://blog.csdn.net/hjimce/article/details/50866313" target="_blank" rel="external">此文</a>所述，BN也是神经网络中的一层，并且包含待训练的参数，而这些参数也是其精髓之一。下面我将分两个部分来说，(1) BN的优势、原理及推导, 以及(2) BN在TensorFlow下的实现。</p>
<h3 id="BN的优势、原理及推导"><a href="#BN的优势、原理及推导" class="headerlink" title="BN的优势、原理及推导"></a>BN的优势、原理及推导</h3><h4 id="Motivations"><a href="#Motivations" class="headerlink" title="Motivations"></a>Motivations</h4><p>首先，Ioffe和Szegedy在摘要中说明了提出BN的动机，其原文为，<br>    The deep neural network is complicated by the fact that the distribution of each layer’s inputs changes during training, as the parameters of the previous layers change. This slows down the training by requiring <strong>lower learning rates</strong> and <strong>careful parameter initialization</strong>, and makes it notoriously hard to train models with <strong>saturating nonlinearities.</strong> </p>
<p>即在网络的训练过程中，受到上一层参数调整的影响，该层输入的分布会发生变化，使得参数训练要重新适应这一分布变化，导致网络的训练时间和迭代次数增加。为了避免这些问题，<strong>传统方法</strong>只能采用小的学习率以及适当的参数初始化策略; 并且无法避免大数值输出在经过激活函数后进入饱和区 (saturating nonlinearities) 的问题。Ioffe和Szegedy将这一现象命名为<code>internal covariate shift</code>。</p>
<p>LeCun在1998年的论文中提出过这样一个观点，<em>The newtork training converges faster if its inputs are whitened, i.e., linearily transformed to have zero means and unit variances, and decorrelated.</em> 即对网络的输入进行归一化，有利于加速网络的收敛。这一点也是比较好理解的，参考传统机器学习算法，通常分类器的输入是人工提取的特征，这些特征在量纲和数量级上会有相当大的差异性，如果直接输入网络，数值较大的特征便会影响训练结果。为了解决这一问题，通常对特征进行去量纲的操作，最好的方式便是归一化，<strong>这种针对每一维特征进行归一化</strong>的处理方法也是BN的核心。</p>
<p>那么，在具有多层结构的网络内部，是否可以对每一层的输入做归一化处理，既稳定了样本的分布，也能加速网络的收敛。</p>
<h4 id="BN的优势"><a href="#BN的优势" class="headerlink" title="BN的优势"></a>BN的优势</h4><p>根据论文的Abstract和Intro, BN的优势可以概括为以下四点，</p>
<ol>
<li>解决internal convariate shift问题，加速网络训练;</li>
<li>避免了梯度传递过程原始数据大小对参数的影响，使得可以选择大的学习率;</li>
<li>正则化了网络，可以不使用dropout;</li>
<li>将输入集中在小区间内，避免经过激活函数的输出进入饱和区。</li>
</ol>
<h4 id="BN的原理与推导"><a href="#BN的原理与推导" class="headerlink" title="BN的原理与推导"></a>BN的原理与推导</h4><p>BN文的第二节对<strong>normalization</strong>进行了讨论，并在第三节通过两个简化对Batch Normalization进行定义，以解决<strong>Full whitenning of each layer’s inputs is cotly</strong>的问题。</p>
<ol>
<li>Nomalize each scalar feature indepently, by making whitened</li>
<li>Computation over a mini-batch instead of m individuals.</li>
</ol>
<p>定义<script type="math/tex">\mathbf{x}=[x^{(1)}, x^{(2)}, ... , x^{(K)}]</script>,<script type="math/tex">x\in \chi,\chi={x_1,x_2,...,x_m}</script>为该层的输入 (上一层的输出)，其中m表示mini-batch中的样本数。$\hat{x}^{(k)}$表示$\mathbf{x}$第$k$维特征的whitening量，由下式给出</p>
<script type="math/tex; mode=display">
\begin{align}
\hat{x}^{(k)} = \frac{x^{(k)} - E[x^{(k)}]}{\sqrt{Var[x^{(k)}]}}, \notag
\end{align}</script><p>其中$E[\cdot]$和$Var[\cdot]$分别对应$x_i^{(k)}, i=1,2,…,m$的期望和方差。</p>
<p>以上虽然对输入做了归一话，但如BN文中所述<em>Simply normalizing each input of a layer may change what the layer can represent</em>。以激活函数<code>sigmoid</code>为例，如果$x^{(k)}$本来的数值较大，经过sigmoid函数以后会分布在接近饱和区的两端，而白化以后则剧集在sigmoid(x)=0附近，使得原有的分布消失。为了解决这一问题，需要对$\hat{x}$进行尺度(scale)和位移(shift)变换，从而有，</p>
<script type="math/tex; mode=display">
y^{(k)} = \gamma^{(k)} \cdot \hat{x}^{(k)} + \beta^{(k)},</script><p>其中$y^{(k)}$即为BN的输出，$\gamma^{(k)}$和$\beta^{(k)}$分别对应scale和shift，是<code>Batch Normalization layer</code>的参数，需要进行初始化，并在网络训练的过程中进行学习和调整。</p>
<h4 id="BN和activation层的关系"><a href="#BN和activation层的关系" class="headerlink" title="BN和activation层的关系"></a>BN和activation层的关系</h4><p>我们知道，通常在<code>Conv layer</code>和<code>FC layer</code>之后，会加上非线性的激活函数层对输出进行调整，并作为下一层的输入。而BN层也是在<code>Conv layer</code>和<code>FC layer</code>之后对输出进行归一化的，二者的先后关系如何？ 参考BN文3.2节，定义$z$为<code>activation layer</code>的输出，则有，</p>
<script type="math/tex; mode=display">
z = g[\mathrm{BN}(x)],</script><p>即先进行Batch Normalization,后通过激活函数。</p>
<h4 id="BN的训练和测试-inference"><a href="#BN的训练和测试-inference" class="headerlink" title="BN的训练和测试(inference)"></a>BN的训练和测试(inference)</h4><p>BN的训练和测试可以参考下图，截取自Ioffe和Szegedy的论文，这里要注意的是<code>inference</code>的理解，即新样本需要经过怎样的预处理，以利用训练好的网络进行测试？</p>
<p>网络的训练过程采用了<code>batch training</code>，每个batch会有对应的期望$\mu<em>B$和标准差$\sigma</em>{B}$，用于测试网络的样本在每一个layer依然需要归一化，此时对应的$E[x]$和$\mathrm{Var}[x]$用如下式进行估计，</p>
<script type="math/tex; mode=display">
\begin{align}
E[x] &= E[\mu_B], \notag \\
\mathrm{Var}[x] &= \frac{m}{m-1} \cdot E[{\sigma_B}^2], \notag
\end{align}</script><p>进而，BN layer的输出定义为，</p>
<script type="math/tex; mode=display">
y = \frac{\gamma}{\sqrt{\mathrm{Var}[x]+\epsilon}}\cdot x + (\beta - \frac{\gamma E[x]}{\sqrt{\mathrm{Var}[x]+\epsilon}}).</script><center>
<img src="https://github.com/myinxd/canal-images/blob/master/images/blog-180123/fig1.png?raw=true" height="600" width="600">
</center>

<h3 id="BN的TensofFlow实现"><a href="#BN的TensofFlow实现" class="headerlink" title="BN的TensofFlow实现"></a>BN的TensofFlow实现</h3><p>白化本身是很简单的，关键问题是如何训练每个$x^{(k)}$对应的$\gamma^{(k)}$和$\beta^{(k)}$。TensofFlow提供了多个<code>batch_normalization</code>相关的类或方法，比较简单的有<code>tf.nn.batch_normalization</code>，其参数如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">batch_normalization(</div><div class="line">    x, <span class="comment"># inputs</span></div><div class="line">    mean, <span class="comment"># 均值</span></div><div class="line">    variance, <span class="comment"># 方差</span></div><div class="line">    offset, <span class="comment"># shift beta</span></div><div class="line">    scale, <span class="comment"># scale gamma</span></div><div class="line">    variance_epsilon, <span class="comment"># epision</span></div><div class="line">    name=<span class="keyword">None</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>简单实现一个DNN分类手写体的样例，这里基于<code>tf.nn.moments</code>生成<code>mean</code>和<code>varianciences</code>两个tensor<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</div><div class="line">mnist = input_data.read_data_sets(<span class="string">"MNIST_data"</span>, one_hot=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">x = tf.placeholder(tf.float32, shape=[<span class="keyword">None</span>, <span class="number">784</span>])</div><div class="line">y_ = tf.placeholder(tf.float32, shape=[<span class="keyword">None</span>, <span class="number">10</span>]) <span class="comment"># one-hot 10-dimensional vector</span></div><div class="line"></div><div class="line">l_FC1 = <span class="number">512</span></div><div class="line">W_FC1 = tf.Variable(tf.truncated_normal(shape=[<span class="number">784</span>,l_FC1], stddev=<span class="number">0.1</span>))</div><div class="line">b_FC1 = tf.Variable(tf.constant(<span class="number">0.1</span>,shape=[l_FC1]))</div><div class="line"></div><div class="line"><span class="comment"># batch_norm_l1</span></div><div class="line">x_FC1 = tf.matmul(x, W_FC1)+b_FC1</div><div class="line">axis = list(range(len(x_FC1.get_shape()) - <span class="number">1</span>))</div><div class="line">mean_FC1,var_FC1 = tf.nn.moments(x_FC1, axis)</div><div class="line">gamma_FC1 = tf.Variable(tf.constant(<span class="number">0.1</span>, shape=mean_FC1.get_shape()))</div><div class="line">beta_FC1 = tf.Variable(tf.constant(<span class="number">0.1</span>, shape=mean_FC1.get_shape()))</div><div class="line">y_bn1 = tf.nn.batch_normalization(</div><div class="line">    x = x_FC1,</div><div class="line">    mean = mean_FC1,</div><div class="line">    variance = var_FC1,</div><div class="line">    offset = beta_FC1,</div><div class="line">    scale = gamma_FC1,</div><div class="line">    variance_epsilon = <span class="number">1e-5</span>,</div><div class="line">    name= <span class="string">'BN_FC1'</span>)</div><div class="line">y_FC1 = tf.nn.relu(y_bn1)</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>测试部分单独开一个坑，见<a href="http://www.mazhixian.me/2018/01/25/how-to-apply-the-batch-normalized-net/">How to apply the batch-normalized net</a>.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] <a href="http://proceedings.mlr.press/v37/ioffe15.html" target="_blank" rel="external">Ioffe, S. and Szegedy, C., 2015, June. Batch normalization: Accelerating deep network training by reducing internal covariate shift. In International Conference on Machine Learning (pp. 448-456).</a><br>[2] <a href="http://blog.csdn.net/hjimce/article/details/50866313" target="_blank" rel="external">Batch Normalization 学习笔记</a><br>[3] <a href="https://www.jianshu.com/p/0312e04e4e83" target="_blank" rel="external">谈谈Tensorflow的Batch Normalization</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/23/batch-normalization-with-tensorflow/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/22/hexo-deploy-google-analytics-to-your-website/">
                            Hexo-- deploy google analytics to your website
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-22T14:17:32+08:00">
	
		    Jan 22, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>写之前吐槽一下百度的<a href="https://ziyuan.baidu.com/" target="_blank" rel="external">站长平台</a>，添加新站搜索必须要备案，然后就放弃了。。。转到谷歌的<a href="https://analytics.google.com/" target="_blank" rel="external">Google Analytics, GA</a>，可以统计网站的访问数据。搜索了一下，多数<a href="https://hexo.io/" target="_blank" rel="external">hexo</a>模板都嵌入了google analytics相关的ejs，添加起来还是比较方便的。</p>
<p>下面以我用的模板<a href="https://github.com/LouisBarranqueiro/hexo-theme-tranquilpeak" target="_blank" rel="external">tranquilpeak</a>为例，介绍一下添加的步骤，</p>
<h4 id="1-注册GA账户并添加网站"><a href="#1-注册GA账户并添加网站" class="headerlink" title="1. 注册GA账户并添加网站"></a>1. 注册GA账户并添加网站</h4><p>首先利用谷歌帐号登录Google Analytics，设置关联，而后添加网站信息，如下图所示，</p>
<center>
<img src="https://github.com/myinxd/canal-images/blob/master/images/blog-180122/fig1.png?raw=true" height="600" width="600">
</center>

<h4 id="2-获取UA"><a href="#2-获取UA" class="headerlink" title="2. 获取UA"></a>2. 获取UA</h4><p>添加好网站信息以后，GA会提供一个名为<code>UA</code>的ID (例如 UA-xxxxxx-x) 以及用于添加进网站页面的<code>gtga.js</code>段代码，如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Global site tag (gtag.js) - Google Analytics --&gt;</div><div class="line">&lt;script async src=<span class="string">"https://www.googletagmanager.com/gtag/js?id=UA-xxxxx-x"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  window.dataLayer = window.dataLayer || [];</div><div class="line">  <span class="keyword">function</span> <span class="function"><span class="title">gtag</span></span>()&#123;dataLayer.push(arguments);&#125;</div><div class="line">  gtag(<span class="string">'js'</span>, new Date());</div><div class="line"></div><div class="line">  gtag(<span class="string">'config'</span>, <span class="string">'UA-xxxxx-x'</span>);</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-在模板中添加GA支持"><a href="#3-在模板中添加GA支持" class="headerlink" title="3. 在模板中添加GA支持"></a>3. 在模板中添加GA支持</h4><p>对于<code>tranquilpeak</code>模板，配置<code>google-analytics</code>是比较简单的，只需要修改<code>theme/tranquilpeal/_config.yml</code>文件中的<code>google-analytics-id</code>部分，如下所示，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Your Google analystics web property ID : UA-XXXXX-X</span></div><div class="line">google_analytics_id: UA-xxxx-x</div></pre></td></tr></table></figure></p>
<p>同样的，相应的<code>google-analytics.ejs</code>文件可以在<code>theme/tranquilpeak/layout/_partial</code>中找到, 其代码如下所示，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;% <span class="keyword">if</span> (theme.google_analytics_id) &#123; %&gt;</div><div class="line">    &lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</div><div class="line">        (<span class="keyword">function</span>(i,s,o,g,r,a,m)&#123;i[<span class="string">'GoogleAnalyticsObject'</span>]=r;i[r]=i[r]||<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">        (i[r].q=i[r].q||[]).push(arguments)&#125;,i[r].l=1*new Date();a=s.createElement(o),</div><div class="line">        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)</div><div class="line">        &#125;)(window,document,<span class="string">'script'</span>,<span class="string">'//www.google-analytics.com/analytics.js'</span>,<span class="string">'ga'</span>);</div><div class="line"></div><div class="line">        ga(<span class="string">'create'</span>, <span class="string">'&lt;%= theme.google_analytics_id %&gt;'</span>, <span class="string">'auto'</span>);</div><div class="line">        ga(<span class="string">'send'</span>, <span class="string">'pageview'</span>);</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure></p>
<p>其中的<code>theme.google_analytics_id</code>便对应刚刚我们添加的<code>UA-xxxx-x，该文件不需要修改。当然也可以尝试将GA提供的基于</code>gtag.js<code>代码替换到</code>google-analysis.ejs`中，感兴趣可以试试看。</p>
<h4 id="4-编译并部署"><a href="#4-编译并部署" class="headerlink" title="4. 编译并部署"></a>4. 编译并部署</h4><p>最后，利用<code>hexo g</code>重新编译相关文件，在每一个<code>.html</code>页面中加入<code>GA</code>相关的内容，谷歌的分析服务便可以发挥作用。</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>[1] <a href="https://github.com/LouisBarranqueiro/hexo-theme-tranquilpeak" target="_blank" rel="external">hexo-theme-tranquilpeak</a><br>[2] <a href="https://www.cnblogs.com/zhcncn/p/4097881.html" target="_blank" rel="external">Hexo搭建Github静态博客</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/22/hexo-deploy-google-analytics-to-your-website/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/21/resnet-with-tensorflow/">
                            Residual network I -- block and bottleneck
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-21T14:15:00+08:00">
	
		    Jan 21, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>ResNet (Residual Neural Network)由何凯明等在15年提出，这里做个笔记，参考了<a href="https://www.amazon.cn/dp/B06X8Z4BS9/" target="_blank" rel="external">TensorFlow 实战</a>的6.4节。ResNet的结构能加速超深神经网络的训练，能有效避免过拟合，而且推广性非常好。</p>
<p>深度神经网络存在<code>Degradation</code>的问题，即随着网络层数的增加，其准确率会从逐渐提升到饱和，进而下降。这一问题在我们近期的工作也出现了，我们在增加了一层全连接后，网络的准确率反而下降了。为了解决这一问题，ResNet提出了一种新的网络思路，<strong>即允许原始输入信息直接传输到后面的层中</strong>。假定某段网络的输入是<script type="math/tex">\mathrm{x}</script>，期望输出是<script type="math/tex">H(\mathrm{x})</script>，如果直接将<script type="math/tex">\mathrm{x}</script>传到输出作为初始结果，那么目标函数变为</p>
<script type="math/tex; mode=display">
\begin{equation}
F(\mathrm{x}) = H(\mathrm{x}) - \mathrm{x}
\end{equation}</script><p>如下图所示为一个ResNet的残差学习单元，即将学习目标从<script type="math/tex">H(\mathrm{x})</script>改为期望与输入的残差。这种结构也被称为<code>shortcut</code>或<code>skip connections</code>.</p>
<center>
<img src="https://github.com/myinxd/canal-images/blob/master/images/blog-180119/fig3.png?raw=true" height="200" width="300">
</center>

<p>考虑到神经网络相当于对原始数据进行了压缩，存在信息损失的问题，而ResNet结构将部分输入信息直接传递到输出端，可以保留部分的信息。并且ResNet的训练误差会随着层数增加而逐渐减少，并且在测试集上也有很好的表现。</p>
<p>引自TensorFlow实战，在ResNet的第二篇论文<em>Identity mapping in deep residual networks</em>中，提出了ResNet V2。想对于ResNet V1, 将激活函数<code>ReLU</code>改为了<code>Identity mapping</code>，即y=x。同时，ResNet V2在每一层都使用了Batch Normalization，提升网络的范化能力。</p>
<h3 id="ResNet的block的理解"><a href="#ResNet的block的理解" class="headerlink" title="ResNet的block的理解"></a>ResNet的block的理解</h3><p>在ResNet的实现中，包含多个<code>block</code>，每个<code>block</code>又由多个<code>bottleneck</code>组成，称为<strong>残差学习单元</strong>，ResNet的残差运算即在每个bottleneck内实现。因为要获取输入<script type="math/tex">\mathrm{x}</script>与block输出的残差，每个<code>bottleneck</code>虽然做了多次卷积和激活运算，但其输出的<code>shape</code>应该保持不变，因此内部的卷积运算的<code>stride</code>和<code>padding</code>都有特殊的设置 (数学推导可以参考<a href="http://deeplearning.net/software/theano_versions/dev/tutorial/conv_arithmetic.html" target="_blank" rel="external">此文</a>)。以ResNet-50的第二个block为例，假设该block内包含两个bottleneck单元，则有，</p>
<h5 id="Bottleneck-One"><a href="#Bottleneck-One" class="headerlink" title="Bottleneck One"></a>Bottleneck One</h5><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Layer</th>
<th style="text-align:center">Input</th>
<th style="text-align:center">Kernel</th>
<th style="text-align:center">Stride</th>
<th style="text-align:center">Padding</th>
<th style="text-align:center">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Conv1,1</td>
<td style="text-align:center">56x56x64</td>
<td style="text-align:center">1x1x64</td>
<td style="text-align:center">1</td>
<td style="text-align:center">SAME</td>
<td style="text-align:center">56x56x64</td>
</tr>
<tr>
<td style="text-align:center">Conv1,2</td>
<td style="text-align:center">56x56x64</td>
<td style="text-align:center">3x3x64</td>
<td style="text-align:center">1</td>
<td style="text-align:center">SAME</td>
<td style="text-align:center">56x56x64</td>
</tr>
<tr>
<td style="text-align:center">Conv1,3</td>
<td style="text-align:center">56x56x64</td>
<td style="text-align:center">1x1x256</td>
<td style="text-align:center">1</td>
<td style="text-align:center">SAME</td>
<td style="text-align:center">56x56x256</td>
</tr>
</tbody>
</table>
</div>
<h5 id="Bottleneck-Two"><a href="#Bottleneck-Two" class="headerlink" title="Bottleneck Two"></a>Bottleneck Two</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Layer</th>
<th style="text-align:center">Input</th>
<th style="text-align:center">Kernel</th>
<th style="text-align:center">Stride</th>
<th style="text-align:center">Padding</th>
<th style="text-align:center">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>Conv2,1</td>
<td style="text-align:center">56x56x256</td>
<td style="text-align:center">1x1x64</td>
<td style="text-align:center">1</td>
<td style="text-align:center">SAME</td>
<td style="text-align:center">56x56x64</td>
</tr>
<tr>
<td>Conv2,2</td>
<td style="text-align:center">56x56x64</td>
<td style="text-align:center">3x3x64</td>
<td style="text-align:center"><em>2</em></td>
<td style="text-align:center">SAME</td>
<td style="text-align:center">28x28x64</td>
</tr>
<tr>
<td>Conv2,3</td>
<td style="text-align:center">28x28x64</td>
<td style="text-align:center">1x1x256</td>
<td style="text-align:center">1</td>
<td style="text-align:center">SAME</td>
<td style="text-align:center"><em>28x28x256</em></td>
</tr>
</tbody>
</table>
</div>
<p>注意<code>Bottleneck Two</code>的<code>Conv2,3</code>层的<code>stride</code>为2,因此输出的尺度大小相当于做了factor为2的降采样，因此该bottleneck不做残差的运算，其输出直接作为下一个block的输入。</p>
<p>ResNet-V2相对于ResNet-V1增加了<code>Batch Normalization</code>和<code>L2</code>正则，如何在block中体现？ 且听下回分解。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/21/resnet-with-tensorflow/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/21/python-decorator/">
                            python decorator
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-21T13:04:21+08:00">
	
		    Jan 21, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>简单记录一下python修饰符<code>@</code>的理解和使用方法，一直没好好理解，现在卡住了。。。参考<a href="https://en.wikipedia.org/wiki/Python_syntax_and_semantics#Decorators" target="_blank" rel="external">wiki</a>的定义, A decorator is any callable Python object that is used to <strong>modify a function, method or class defination</strong>. The decorator syntax is pure syntactic sugar, using <code>@</code> as the keyword.即python修饰符作为一种python对象，用来修饰函数、方法或者类。</p>
<p>参考Wiki，我们简单实现一个修饰符的样例，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculator</span><span class="params">(f)</span>:</span></div><div class="line">    print(<span class="string">"Begin..."</span>)</div><div class="line">    a = <span class="number">3.0</span></div><div class="line">    b = <span class="number">2.0</span></div><div class="line">    f(a,b)</div><div class="line">    print(<span class="string">"End"</span>)</div><div class="line"></div><div class="line"><span class="meta">@calculator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_add</span><span class="params">(a,b)</span>:</span></div><div class="line">    print(<span class="string">"%.2f + %.2f = %.2f"</span> % (a,b,a+b))</div><div class="line"></div><div class="line"><span class="meta">@calculator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_minus</span><span class="params">(a,b)</span>:</span></div><div class="line">    print(<span class="string">"%.2f - %.2f = %.2f"</span> % (a,b,a-b))</div></pre></td></tr></table></figure>
<p>在ipython环境下执行，有如下结果，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Begin...</div><div class="line"><span class="number">3.00</span> + <span class="number">2.00</span> = <span class="number">5.00</span></div><div class="line">End</div><div class="line">Begin...</div><div class="line"><span class="number">3.00</span> - <span class="number">2.00</span> = <span class="number">1.00</span></div><div class="line">End</div></pre></td></tr></table></figure></p>
<p>所以，修饰符的用途，等价于如下情形，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">3.0</span>, b = <span class="number">2.0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">"Begin..."</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>calc_add(a,b)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">"End"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">"Begin..."</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>calc_minus(a,b)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">"End"</span>)</div></pre></td></tr></table></figure></p>
<p>最直观的理解就是decorator简化了<code>calculator()</code>中的部分代码。正如wiki中的解释：Decorators are a form of metaprogramming; they enhance the action of the function or method they decorate. </p>
<p>这篇<a href="http://blog.csdn.net/972301/article/details/59537712" target="_blank" rel="external">博客</a>还分析了修饰符嵌套的执行顺序问题，感兴趣可以参考一下。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] <a href="https://en.wikipedia.org/wiki/Python_syntax_and_semantics#Decorators" target="_blank" rel="external">Python syntax and semantics#Decorators</a><br>[2] <a href="http://blog.csdn.net/972301/article/details/59537712" target="_blank" rel="external">Python修饰符 （一）—— 函数修饰符 “@”</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/21/python-decorator/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/19/adjustable-learning-rate-for-deep-learning-by-tensorflow/">
                            Adjustable learning rate for deep learning by TensorFlow
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-19T09:11:34+08:00">
	
		    Jan 19, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>趁着最近空闲一点，继续纠结TensorFlow学习率调整的问题。学习率对网路训练的影响还是挺大的，初始化时可以采用大的学习率，帮助网络快速收敛。但网络的梯度是非线性的，随着迭代次数的增加，梯度的导数趋于变小，如果继续保持大学习率，会出现优化目标在最优解附近波动的情况，如下图所示。此时，为了接近收敛点，需要调整学习率。</p>
<center>
<img src="https://github.com/myinxd/canal-images/blob/master/images/blog-180119/fig1.png?raw=true" height="200" width="360">
</center>

<p>参考<a href="https://www.amazon.cn/dp/B06WGP12TV/ref=sr_1_1?ie=UTF8&amp;qid=1516326593&amp;sr=8-1&amp;keywords=Tensorflow" target="_blank" rel="external">TensorFlow: 实战Google深度学习框架</a>这本书，利用<strong>指数衰减</strong>的方法设置<a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent" target="_blank" rel="external">梯度下降算法</a>的学习率，TensofFLow中集成了这一算法，即<code>tf.train.exponential_decay</code>。其实现了</p>
<script type="math/tex; mode=display">
L^{t+1}_{R} = L^{t}_{R} \cdot R_{d}^{S_g/S_d},</script><p>其中$L_R$表示学习率，$R_d$表示衰减率，$S_g$和$S_d$分别表示总Epochs和每个Epochs中的Batches。从而没迭代一轮，学习率便更新一次。</p>
<p>在TensorFlow中可以用如下代码实现指数衰减的学习率更新。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line">init_lr = tf.Variable(<span class="number">0.</span>, name=<span class="string">"LR"</span>)</div><div class="line">global_step = tf.Variable(<span class="number">0.</span>, name=<span class="string">"global_step"</span>)</div><div class="line">decay_step = tf.Variable(<span class="number">0.</span>, name=<span class="string">"decay_step"</span>)</div><div class="line">decay_rate = tf.Variable(<span class="number">0.</span>, name=<span class="string">"decay_rate"</span>)</div><div class="line">learning_rate = tf.train.exponential_decay(</div><div class="line">    learning_rate = init_lr ,</div><div class="line">    global_step = global_step,</div><div class="line">    decay_steps = decay_step,</div><div class="line">    decay_rate = decay_rate,</div><div class="line">    staircase=<span class="keyword">False</span>,</div><div class="line">    name=<span class="keyword">None</span></div><div class="line">	)</div><div class="line"><span class="comment"># Test</span></div><div class="line">lr_init = <span class="number">0.1</span></div><div class="line">epochs = <span class="number">200</span></div><div class="line">batches = <span class="number">100.</span></div><div class="line">d_rate = <span class="number">0.9</span></div><div class="line">epoch = np.arange(<span class="number">0</span>,epochs,<span class="number">1</span>)</div><div class="line">lr = np.zeros(epoch.shape)</div><div class="line"><span class="comment"># Init a session</span></div><div class="line">init_op = tf.global_variables_initializer()</div><div class="line">sess = tf.InteractiveSession()</div><div class="line">sess.run(init_op)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> epoch.astype(int):</div><div class="line">	lr[i] = sess.run(learning_rate, </div><div class="line">                     feed_dict=&#123;init_lr: lr_init,</div><div class="line">                                global_step: i,</div><div class="line">                                decay_step: batches,</div><div class="line">                                decay_rate: d_rate</div><div class="line">                                &#125;)</div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/myinxd/canal-images/blob/master/images/blog-180119/Learning_rate_adjust_demo.ipynb" target="_blank" rel="external">这里</a>提供了一个样例，其输出结果如下图，通过设置<code>tf.exponential_decay</code>的参数<code>staircase</code>可以控制learning rate是否为阶梯型或者平滑的。</p>
<center>
<img src="https://github.com/myinxd/canal-images/blob/master/images/blog-180119/fig2.png?raw=true" height="360" width="480">
</center>

<p>而在训练网络，优化目标函数的过程中，可以参考官方手册，用如下语句进行梯度更新。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">global_step = tf.Variable(<span class="number">0</span>, trainable=<span class="keyword">False</span>)</div><div class="line">starter_learning_rate = <span class="number">0.1</span></div><div class="line">learning_rate = tf.train.exponential_decay(starter_learning_rate, global_step,</div><div class="line">                                           <span class="number">100000</span>, <span class="number">0.96</span>, staircase=<span class="keyword">True</span>)</div><div class="line"><span class="comment"># Passing global_step to minimize() will increment it at each step.</span></div><div class="line">learning_step = (</div><div class="line">    tf.train.GradientDescentOptimizer(learning_rate)</div><div class="line">    .minimize(...my loss..., global_step=global_step)</div><div class="line">)</div></pre></td></tr></table></figure></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>[1] <a href="https://www.tensorflow.org/api_docs/python/tf/train/exponential_decay" target="_blank" rel="external">exponential decay</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/19/adjustable-learning-rate-for-deep-learning-by-tensorflow/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/16/install-cuda-on-debian-test-with-apt-get/">
                            Install cuda on Debian test with apt-get
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-16T16:57:34+08:00">
	
		    Jan 16, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>继续<code>debian test</code>的坑，如何用<code>apt-get</code>,安装和配置<code>Nvidia CUDA</code>,并解决无法进入桌面的问题。</p>
<h4 id="软件源的配置"><a href="#软件源的配置" class="headerlink" title="软件源的配置"></a>软件源的配置</h4><p><a href="https://developer.nvidia.com/cuda-zone" target="_blank" rel="external">CUDA</a> 属于第三方软件，debian的源中默认是没有的，需要手动添加。添加方法如下：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /etc/apt/sources.list.d</div><div class="line">$ sudo touch debian-testing.list</div><div class="line">$ sudo vim debian-testing.list</div><div class="line"><span class="comment"># 加入如下两个源</span></div><div class="line">deb http://mirrors.ustc.edu.cn/debian/ testing main contrib non-free</div><div class="line">deb-src http://mirrors.ustc.edu.cn/debian/ testing main contrib non-free</div><div class="line">$ sudo apt update</div></pre></td></tr></table></figure></p>
<p>此时，利用<code>apt search cuda</code>，便能找到cuda的安装包了，类似如下的结果<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nvidia-cuda-toolkit/testing,now 8.0.61-3 amd64 [installed]</div><div class="line">  NVIDIA CUDA development toolkit</div></pre></td></tr></table></figure></p>
<p>这里显示<code>installed</code>，是因为我已经安装好了。</p>
<h4 id="安装-CUDA"><a href="#安装-CUDA" class="headerlink" title="安装 CUDA"></a>安装 CUDA</h4><p>添加好软件源后，利用<code>apt install</code>便可以安装，但这之前需要中止图形界面的程序，并禁止系统自带的显卡驱动，具体步骤如下。</p>
<h5 id="禁止系统显卡驱动"><a href="#禁止系统显卡驱动" class="headerlink" title="禁止系统显卡驱动"></a>禁止系统显卡驱动</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /etc/modprobe.d</div><div class="line">$ sudo touch nvidia-blacklists-nouveau.conf</div><div class="line">$ sudo vim nvidia-blacklists-nouveau.conf</div><div class="line"><span class="comment"># Add</span></div><div class="line">blacklist nouveau</div><div class="line"><span class="comment"># 保存并退出，重启显卡服务</span></div><div class="line">$ sudo update-initramfs -u</div></pre></td></tr></table></figure>
<p>此时，再执行<code>lsmod | grep nouveau</code>，若没有显示，则说明配置成功。</p>
<h5 id="中止图形界面并安装CUDA"><a href="#中止图形界面并安装CUDA" class="headerlink" title="中止图形界面并安装CUDA"></a>中止图形界面并安装CUDA</h5><p>同时按<code>Ctrl+Alt+F2</code>进入Console界面，以用户或者root身份登录，执行如下如下指令，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ systemctl stop lightdm.service <span class="comment"># 若使用的是gdm3,则为gdm3.service</span></div><div class="line">$ sudo apt install nvidia-cuda-toolkit</div></pre></td></tr></table></figure></p>
<p>此时，便开始安装CUDA，其中包含了CUDA的一些library和与显卡对应的<code>NVIDIA</code>驱动，例如我安装的驱动为<code>nvidia-384.111</code>。</p>
<h4 id="安装Xserver-xorg-video-nvidia"><a href="#安装Xserver-xorg-video-nvidia" class="headerlink" title="安装Xserver-xorg-video-nvidia"></a>安装Xserver-xorg-video-nvidia</h4><p>这一点单独提出来，是因为我在这里卡了好久。。。因为每安装<code>Xorg</code>对应的驱动，导致开机以后无法进入桌面，这一点<code>Ubuntu</code>真的做得很好。。。<br>在师兄的指导下，找到了问题，下面先列出安装了<code>Xserver-xorg-video-nvidia</code>前后<code>Xorg.0.log</code>的区别，</p>
<ol>
<li>未安装<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[  2891.835] (EE) Failed to load module <span class="string">"nv"</span> (module does not exist, 0)</div><div class="line">[  2891.835] (II) LoadModule: <span class="string">"modesetting"</span></div><div class="line">[  2891.835] (II) Loading /usr/lib/xorg/modules/drivers/modesetting_drv.so</div><div class="line">[  2891.835] (II) Module modesetting: vendor=<span class="string">"X.Org Foundation"</span></div><div class="line">[  2891.835] 	compiled <span class="keyword">for</span> 1.19.5, module version = 1.19.5</div><div class="line">[  2891.835] 	Module class: X.Org Video Driver</div><div class="line">[  2891.835] 	ABI class: X.Org Video Driver, version 23.0</div><div class="line">[  2891.835] (II) LoadModule: <span class="string">"fbdev"</span></div><div class="line">[  2891.835] (II) Loading /usr/lib/xorg/modules/drivers/fbdev_drv.so</div><div class="line">[  2891.835] (II) Module fbdev: vendor=<span class="string">"X.Org Foundation"</span></div><div class="line">[  2891.835] 	compiled <span class="keyword">for</span> 1.19.0, module version = 0.4.4</div><div class="line">[  2891.835] 	Module class: X.Org Video Driver</div><div class="line">[  2891.835] 	ABI class: X.Org Video Driver, version 23.0</div><div class="line">[  2891.835] (II) LoadModule: <span class="string">"vesa"</span></div><div class="line">[  2891.835] (II) Loading /usr/lib/xorg/modules/drivers/vesa_drv.so</div><div class="line">[  2891.835] (II) Module vesa: vendor=<span class="string">"X.Org Foundation"</span></div><div class="line">[  2891.835] 	compiled <span class="keyword">for</span> 1.19.0, module version = 2.3.4</div><div class="line">[  2891.835] 	Module class: X.Org Video Driver</div><div class="line">[  2891.835] 	ABI class: X.Org Video Driver, version 23.0</div><div class="line">[  2891.835] (II) NOUVEAU driver Date:   Fri Apr 21 14:41:17 2017 -0400</div><div class="line">[  2891.835] (II) NOUVEAU driver <span class="keyword">for</span> NVIDIA chipset families :</div><div class="line">[  2891.835] 	RIVA TNT        (NV04)</div><div class="line">[  2891.835] 	RIVA TNT2       (NV05)</div><div class="line">[  2891.835] 	GeForce 256     (NV10)</div><div class="line">[  2891.835] 	GeForce 2       (NV11, NV15)</div><div class="line">[  2891.835] 	GeForce 4MX     (NV17, NV18)</div><div class="line">[  2891.835] 	GeForce 3       (NV20)</div><div class="line">[  2891.835] 	GeForce 4Ti     (NV25, NV28)</div><div class="line">[  2891.835] 	GeForce FX      (NV3x)</div><div class="line">[  2891.835] 	GeForce 6       (NV4x)</div><div class="line">[  2891.835] 	GeForce 7       (G7x)</div><div class="line">[  2891.835] 	GeForce 8       (G8x)</div><div class="line">[  2891.836] 	GeForce GTX 200 (NVA0)</div><div class="line">[  2891.836] 	GeForce GTX 400 (NVC0)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>系统此刻找不到<code>nv</code>有关的驱动，而我又禁止了<code>nouveau</code>，所以无法进入图形界面。而在安装了相应的驱动以后，日志如下</p>
<ol>
<li>已安装<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[    38.430] (II) Applying OutputClass <span class="string">"nvidia"</span> to /dev/dri/card0</div><div class="line">[    38.430] 	loading driver: nvidia</div><div class="line">[    38.430] (==) Matched nvidia as autoconfigured driver 0</div><div class="line">[    38.430] (==) Matched nv as autoconfigured driver 2</div><div class="line">[    38.430] (==) Matched nv as autoconfigured driver 4</div><div class="line">[    38.430] (II) LoadModule: <span class="string">"nvidia"</span></div><div class="line">[    38.431] (II) Loading /usr/lib/xorg/modules/drivers/nvidia_drv.so</div><div class="line">[    38.437] (II) Module nvidia: vendor=<span class="string">"NVIDIA Corporation"</span></div><div class="line">[    38.440] (II) LoadModule: <span class="string">"nv"</span></div><div class="line">[    38.440] (WW) Warning, couldn<span class="string">'t open module nv</span></div><div class="line"><span class="string">[    38.440] (II) UnloadModule: "nv"</span></div><div class="line"><span class="string">[    38.440] (II) Unloading nv</span></div><div class="line"><span class="string">[    38.440] (EE) Failed to load module "nv" (module does not exist, 0)</span></div><div class="line"><span class="string">[    38.997] (==) NVIDIA(0): No modes were requested; the default mode "nvidia-auto-select"</span></div><div class="line"><span class="string">[    38.998] (II) NVIDIA(0):     "DFP-0:nvidia-auto-select"</span></div><div class="line"><span class="string">[    39.015] (II) NVIDIA(0): Setting mode "DFP-0:nvidia-auto-select"</span></div><div class="line"><span class="string">[    39.072] (II) NVIDIA(0): [DRI2]   VDPAU driver: nvidia</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>此刻，虽然有<code>warning</code>,但<code>error</code>已经没有了，系统也可以正常进行到登录部分。此刻查看系统显卡驱动信息，会发现出现了<code>nvidia</code>,如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ lsmod | grep nvidia</div><div class="line">nvidia_drm             53248  1</div><div class="line">drm_kms_helper        192512  1 nvidia_drm</div><div class="line">drm                   438272  4 nvidia_drm,drm_kms_helper</div><div class="line">nvidia_modeset        860160  3 nvidia_drm</div><div class="line">nvidia              13168640  84 nvidia_modeset</div></pre></td></tr></table></figure></p>
<p>安装方法，直接用<code>apt install</code>即可，不再赘述。</p>
<p>最后，讲一下调整<code>Desktop Manager</code>的方法，留做一个tip。可供选择的DM有很多，如<code>lightdm</code>,<code>gdm3</code>,<code>kde</code>等，其中<code>lightdm</code>用得比较多，毕竟<code>ubuntu</code>的用户量很大。那么，如果想要在它们之间进行切换的话，用如下方法<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo dpkg-reconfigure lightdm</div></pre></td></tr></table></figure></p>
<p>在弹出的窗口中选择想要采用的桌面管理器即可。</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/16/install-cuda-on-debian-test-with-apt-get/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/15/configure-rtl1868-wireless-ethernet-card-on-ubuntu1610/">
                            Configure rtl8168 wireless ethernet card on Ubuntu 16.10
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-15T10:33:02+08:00">
	
		    Jan 15, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>Ubuntu 16.10 配置无线网卡驱动的问题，同样适用14.04和16.04。针对的设备是<code>Realtek RTL8111/8168 PCI Express Gigabit Ethernet Controller</code>，表现为网络不稳定，经常掉线，且网速较慢，分析后认为是驱动不匹配。</p>
<p><strong>Ubuntu自带的驱动为<code>r8169</code>，高于此类网卡，导致兼容性差，影响了网络连接效果。</strong> 解决方法如下，参考链接见文末。</p>
<h3 id="1-Check-driver-and-device-info"><a href="#1-Check-driver-and-device-info" class="headerlink" title="1. Check driver and device info"></a>1. Check driver and device info</h3><p>查看系统为网卡型号和对应的驱动，利用如下指令<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ lspci -vv &gt;&gt; device.txt</div></pre></td></tr></table></figure></p>
<p>打开<code>device.txt</code>，找到网卡设备，样例如下。其中驱动部分显示为<code>r8169</code>，与现有网卡不吻合<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 0b)</div><div class="line">Subsystem: Acer Incorporated [ALI] RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller</div><div class="line">Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B-DisINTx+</div><div class="line">Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</div><div class="line">Latency: 0, Cache Line Size: 64 bytes</div><div class="line">Interrupt: pin A routed to IRQ 27</div><div class="line">Region 0: I/O ports at d000 [size=256]</div><div class="line">Region 2: Memory at f7104000 (64-bit, prefetchable) [size=4K]</div><div class="line">Region 4: Memory at f7100000 (64-bit, prefetchable) [size=16K]</div><div class="line">Capabilities: &lt;access denied&gt;</div><div class="line">Kernel driver <span class="keyword">in</span> use: r8169</div><div class="line">Kernel modules: r8169</div></pre></td></tr></table></figure></p>
<h4 id="2-Download-driver-of-r8168"><a href="#2-Download-driver-of-r8168" class="headerlink" title="2. Download driver of r8168"></a>2. Download driver of r8168</h4><p>从<code>Realtek</code>官网下载<code>rtl8168</code>的<a href="http://www.realtek.com.tw/downloads/downloadsView.aspx?Langid=1&amp;PNid=13&amp;PFid=5&amp;Level=5&amp;Conn=4&amp;DownTypeID=3&amp;GetDown=false#2" target="_blank" rel="external">驱动</a>, 需要根据Linux的内核版本进行选择，例如我的内核是4.9.1,则选择<code>4.7</code>以上的驱动。</p>
<h4 id="3-Install-driver"><a href="#3-Install-driver" class="headerlink" title="3. Install driver"></a>3. Install driver</h4><p>安装驱动，用如下指令，安装完成后要重启系统。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ tar -xvf 0010-r8168-8.045.08.tar.bz2</div><div class="line">$ <span class="built_in">cd</span> r8168-8.045.08 </div><div class="line">$ sudo ./autorun.sh</div><div class="line">$ sudo reboot</div></pre></td></tr></table></figure></p>
<p>重启以后，理论上网络连接恢复正常。重新查看系统设备信息，有如下结果，驱动已经更新为<code>r8168</code>。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 0b)</div><div class="line">Subsystem: Acer Incorporated [ALI] RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller</div><div class="line">Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B-DisINTx+</div><div class="line">Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</div><div class="line">Latency: 0, Cache Line Size: 64 bytes</div><div class="line">Interrupt: pin A routed to IRQ 27</div><div class="line">Region 0: I/O ports at d000 [size=256]</div><div class="line">Region 2: Memory at f7104000 (64-bit, prefetchable) [size=4K]</div><div class="line">Region 4: Memory at f7100000 (64-bit, prefetchable) [size=16K]</div><div class="line">Capabilities: &lt;access denied&gt;</div><div class="line">Kernel driver <span class="keyword">in</span> use: r8168</div><div class="line">Kernel modules: r8168</div></pre></td></tr></table></figure></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>[1] <a href="https://www.cnblogs.com/duwanjiang/p/5907634.html" target="_blank" rel="external">Ubuntu 16.04 RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller” 不能上网</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/15/configure-rtl1868-wireless-ethernet-card-on-ubuntu1610/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/14/install-and-configure-debian-test/">
                            Install and configure debian test
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-14T16:58:02+08:00">
	
		    Jan 14, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>美好的周日贡献给重装系统了，因为又手残了。既上周日删除了自己的home目录以后，这周直接把系统的权限折腾乱了，起因是我用了<code>sudo chown -R</code>，系统真的有提示我的。。。所以是我的锅。</p>
<p>近期使用的系统是Ubuntu-16.10，考虑到<a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown-Spectre</a>漏洞的补丁还不支持，想着换个系统算了，就入了debian的坑。。。嗯，这个坑更大！！！</p>
<p>于是，一边填坑，一边记录一下步骤，有种预感最近还是会折腾系统。</p>
<h3 id="debian系统安装"><a href="#debian系统安装" class="headerlink" title="debian系统安装"></a>debian系统安装</h3><p>debian-testing的iso下载路径，可以在USTC的<a href="https://mirrors.ustc.edu.cn" target="_blank" rel="external">镜像站</a>找，我尝试安装debian-9，可能刻录的时候有问题，无法安装，所以改用了<code>network install</code>的版本。使用了<a href="https://cn.ultraiso.net/" target="_blank" rel="external">UltraISO</a>烧写到U盘里，他们的试用版功能已经足够了。烧写好以后开始安装，按流程走就行。这里要注意的地方是： <strong>挂载/目录的分区需要格式化，否则无法安装</strong>。主要原因是与原有的<code>ubuntu</code>系统文件存在冲突。</p>
<h4 id="多系统引导"><a href="#多系统引导" class="headerlink" title="多系统引导"></a>多系统引导</h4><p>Debian采用grub引导多系统，我是在<code>win10</code>基础上安装Linux系统的，并通过<code>debian</code>引导<code>windows</code>。在重装的过程中，碰到了windows分区没有被读出并列在引导列表中的情形，有一个简答的解决方法，更新一下grub配置, 即<code>update-grub</code><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo update-grub</div></pre></td></tr></table></figure></p>
<p>一般更新后的列表后会出现对应<code>windows</code>的分区和条目。当然这个是运气，如果碰到其他问题，建议问谷歌。。。</p>
<h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><p>我选择了<code>gnome</code>桌面环境，系统本身还是很好看的，但也有一些bug，比如<code>gnome-terminal</code>就很丑。。。除此之外，debian比ubuntu预装的软件少很多，例如常用<code>sudo</code>，<code>locate</code>等都需要自己安装，对新手来说比较坑。下面说一下我的配置过程，</p>
<h4 id="terminal-shortcuts"><a href="#terminal-shortcuts" class="headerlink" title="terminal shortcuts"></a>terminal shortcuts</h4><p>Ubuntu默认的<code>terminal</code>快捷键是<code>Ctrl+Alt+T</code>，debian是没有这个快捷键的，需要自己添加。具体的思路是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">system setting -&gt; devices -&gt; keyboard -&gt; &quot;+&quot; -&gt; add a new shortcut</div></pre></td></tr></table></figure></p>
<p>Terminal默认的shell通常为<code>bash</code>，如果要更换为其他的，例如<a href="http://ohmyz.sh/" target="_blank" rel="external">zsh</a>, 则执行如下指令即可<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ chsh -s /usr/bin/zsh</div></pre></td></tr></table></figure></p>
<p>此处会提示用户输入密码。</p>
<h4 id="sudoer-及-sudo安装"><a href="#sudoer-及-sudo安装" class="headerlink" title="sudoer 及 sudo安装"></a>sudoer 及 sudo安装</h4><p>打开terminal以后，便可以安装和配置软件，此时需要<code>sudo</code>来临时使用<code>root</code>权限，debian默认不将用户添加到<code>sudoer</code>列表里，因此需要手动添加，步骤如下，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">首先按Ctrl+Alt+F3，进入console，以root身份登录，在安装系统时会要求设置root的密码</div><div class="line">进入以后，执行如下步骤</div><div class="line">1. 添加user到root的group里</div><div class="line"><span class="comment"># usermod -G root user</span></div><div class="line">2. 修改sudoers文件为可写</div><div class="line"><span class="comment"># chmod +w /etc/sudoers</span></div><div class="line">3. 编辑sudoers文件，添加用户</div><div class="line"><span class="comment"># vim /etc/sudoers</span></div><div class="line"><span class="comment"># user ALL=(ALL:ALL) ALL</span></div><div class="line">4. 修改sudoers文件为只读</div><div class="line"><span class="comment"># chmod -w /etc/sudoers</span></div></pre></td></tr></table></figure></p>
<p>再按<code>Ctrl+Alt+F1</code>回到图形界面，此时便可以用root权限安装<code>sudo</code>，并进一步安装其他软件了。</p>
<h4 id="系统语言及locale配置"><a href="#系统语言及locale配置" class="headerlink" title="系统语言及locale配置"></a>系统语言及locale配置</h4><p>由于要使用中文，我通常会用中文安装系统，再修改系统为英文。在Ubuntu中，直接在设置中设置语言即可;在debian中会更纯粹一些，即设置系统语言并调整<code>locale</code>的配置。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo vim /etc/locale.gen</div><div class="line"><span class="comment"># 将需要的语言反注释掉，如 en-US.UTF-8</span></div></pre></td></tr></table></figure></p>
<p>再在system setting中调整语言支持即可,或者执行如下指令进行设置。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo dkpg-reconfigure locale</div></pre></td></tr></table></figure></p>
<h4 id="时区调整"><a href="#时区调整" class="headerlink" title="时区调整"></a>时区调整</h4><p>改变语言为英文后，系统会采用UTC时间，此时会出现即使时区选择为<code>Asia/Shanghai</code>，依然与北京时间相差八个小时的情况，这也说明系统与Network Time没有同步，解决方法如下，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo apt install ntpdate</div><div class="line">$ sudo ntpdate time.windows.com</div></pre></td></tr></table></figure></p>
<p>即将系统时间与<code>windows</code>提供的网络时间同步，这样便会根据系统时区找到对应的时间了。</p>
<h4 id="Genome-窗口调整问题"><a href="#Genome-窗口调整问题" class="headerlink" title="Genome 窗口调整问题"></a>Genome 窗口调整问题</h4><p>gnome默认的窗口控件没有最大化和最小化，刚转过来会不习惯，解决方法是在<code>genome-tweak-tool</code>的<code>windows</code>选项中进行设置。</p>
<h4 id="gnome-terminal-无法正常运行"><a href="#gnome-terminal-无法正常运行" class="headerlink" title="gnome-terminal 无法正常运行"></a>gnome-terminal 无法正常运行</h4><p>这个通常与调整了系统语言相关，即locale的语言设置与系统语言冲突，或未设置，导致genome-terminal无法初始化窗口，解决方法是，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo "LANG=zh-CN.UTF-8" &gt;&gt; /etc/locale.conf</span></div></pre></td></tr></table></figure></p>
<h4 id="系统切换以后block-size的问题"><a href="#系统切换以后block-size的问题" class="headerlink" title="系统切换以后block size的问题"></a>系统切换以后block size的问题</h4><p>这个情况比较特殊，实验室可能只有我碰到过。在一块SSD上安装了windows和linux双系统，并且上一次运行的系统是windows, 则开机后因为<code>ext4</code>分区的block错误，导致无法引导进入Linux，目前有两个指令可以解决这一问题，并且要求有<strong>livecd USB</strong>，即能独立引导的最小化系统。可用的指令分别为<code>fsck</code>和<code>e2fsck</code>，二者的区别，我争取专门写一篇，目前还不太理解。</p>
<p>首先用<code>sudo fdisk -l</code>查看文件格式为<code>ext3/ext4</code>的分区，着重关注包含有<code>Linux</code>系统的主分区，然后修复<code>block</code>的问题。</p>
<ol>
<li><p>fsck</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># fsck -t ext4 /dev/sda1</span></div></pre></td></tr></table></figure>
</li>
<li><p>e2fsck</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># e2fsck -b 32768 /dev/sda1</span></div><div class="line">-b 表示 superblock，具体的解释&lt;TODO&gt;...</div></pre></td></tr></table></figure>
</li>
</ol>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/14/install-and-configure-debian-test/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2018/01/12/capture-video-flow-from-firefox/">
                            Capture video flow from firefox
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-01-12T13:17:08+08:00">
	
		    Jan 12, 2018
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>今天讨论网页视频流抓取问题，针对Firefox浏览器，有两种方法。</p>
<ol>
<li>直接从Firefox的缓存中获取;</li>
<li>利用flash流的进程号，在系统/proc下抓取缓存的数据流。</li>
</ol>
<h3 id="Firefox-缓存提取"><a href="#Firefox-缓存提取" class="headerlink" title="Firefox 缓存提取"></a>Firefox 缓存提取</h3><p>Firefox的缓存保存在如下的路径中，其中<code>f176xa6s.default</code>不同的用户会不同，其他路径成分基本相同。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/.cache/mozilla/firefox/fl76xa6s.default/cache2/entries</div></pre></td></tr></table></figure></p>
<p>进入缓存文件夹后，便可以根据时间和文件大小搜索缓存文件。因为文件名是16进制编码的，无法体现文件内容，所以不考虑。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ls -lSt</div></pre></td></tr></table></figure></p>
<p>其中<code>-S</code>表示按文件大小排序，<code>-t</code>表示按时间先后排序。</p>
<p>通常视频文件大小为<code>MB</code>量级，所以一般排序在前的几个文件会是缓存的视频。</p>
<h3 id="Firefox-flash-flow-抓取"><a href="#Firefox-flash-flow-抓取" class="headerlink" title="Firefox flash flow 抓取"></a>Firefox flash flow 抓取</h3><p>从Firefox网页抓取flash插件播放的视频流的步骤分为三步，(1) 打开视频、(2) 获取flash播放进程ID、(3) 视频流转存。</p>
<h4 id="Step1-打开视频"><a href="#Step1-打开视频" class="headerlink" title="Step1 打开视频"></a>Step1 打开视频</h4><p>在浏览器播放视频，此处需要firefox支持flash，或者安装adobe flash插件。</p>
<h4 id="Step2-获取flash播放进程ID"><a href="#Step2-获取flash播放进程ID" class="headerlink" title="Step2 获取flash播放进程ID"></a>Step2 获取flash播放进程ID</h4><p>利用<code>lsof</code>抓取正在运行的<code>Flash</code>进程，如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ lsof | grep Flash</div></pre></td></tr></table></figure></p>
<p>会输出如下类似的结果，其中<code>31346</code>即为目标ID.<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plugin-co 31346 user 26u REG 8,5  4561004  787806 /tmp/FlashXXJa3CWn (deleted)</div></pre></td></tr></table></figure></p>
<h4 id="Step3-视频流转存"><a href="#Step3-视频流转存" class="headerlink" title="Step3 视频流转存"></a>Step3 视频流转存</h4><p>参考<a href="http://www.cpplive.com/html/1424.html" target="_blank" rel="external">博客</a>: Linux下的浏览器播放flv视频都是采用的Flash播放器，而Flash播放器在播放每个视频的时候都会在/tmp目录下创建以“Flash”字样开头做标识的缓存文件，但是如果我们进入到/tmp目录下察看所有文件，却找不到正在播放的缓存文件，因为这些视频缓存文件只有系统可见，对用户是隐藏的。因此，我们可以根据Flash进程的ID，进入系统进程文件<code>/proc</code>下，获取缓存的视频流。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ls /proc/31346/fd</div><div class="line"><span class="comment"># 找到类似如下的行，其中 26 便是视频流缓存</span></div><div class="line">lrwx------ 1 user user 64 Jan  12 12:07 26 -&gt; /tmp/FlashXXJa3CWn (deleted)</div></pre></td></tr></table></figure>
<p>利用<code>cat</code>和<code>管道</code>,将数据流输入到<code>.flv</code>文件中。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat /proc/31346/fd/26 &gt; ~/Desktop/test1.flv</div></pre></td></tr></table></figure></p>
<h3 id="视频格式转换"><a href="#视频格式转换" class="headerlink" title="视频格式转换"></a>视频格式转换</h3><p>利用<code>mencoder</code>可以对视频文件进行格式转换，<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mencoder -ovc lavc -lavcopts vcodec=mpeg4 -oac mp3lame source.flv -o dest.mp4</div></pre></td></tr></table></figure></p>
<p>其中参数含义如下，参考了<a href="https://www.cnblogs.com/jdksummer/articles/2561461.html" target="_blank" rel="external">此文</a></p>
<ul>
<li><p>-ovc lavc：（output video codec）指定输出视频文件的视频编码类型，此处选择的是 Libavcodec 的视频编码；</p>
</li>
<li><p>-lavcopts vcodec=mpeg4：（Libavcodec options）指定视频编码的设置，由于 Libavcodec 包含了多种视频编码，所以用 vcodec=mpeg4 来指定具体的使用 MPEG-4 编码；</p>
</li>
<li><p>-oac mp3lame：（output audio codec）指定输出媒体文件的音频编码类型，此处选择的是 mp3lame；</p>
</li>
</ul>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] <a href="http://www.cpplive.com/html/1424.html" target="_blank" rel="external">Linux下提取保存浏览器中的视频</a><br>[2] <a href="https://www.cnblogs.com/jdksummer/articles/2561461.html" target="_blank" rel="external">linux下视频格式转换工具</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2018/01/12/capture-video-flow-from-firefox/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="/all-archives/page/2/">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span>NEWER POSTS</span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/all-archives/page/4/">
              <span>OLDER POSTS</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 3 of 6</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 Jason Ma. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Jason Ma</h4>
        
            <div id="about-card-bio"><p>We are in the same story.</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Astronomer? Software engineer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Shanghai
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-peofhqjkzcghmndknakluequy1y6owxdwpaqyju9ntl9zxnk7rdolb3rjjoj.min.js"></script>
<!--SCRIPTS END--><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



    </body>
</html>
